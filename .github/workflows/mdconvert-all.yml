name: Convert All of the IPython Notebooks into Markdown
on:
  workflow_dispatch:
    inputs:
      website_config_file:
        description: 'Website Config'
        required: true
        default: 'website.config.json'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Contents in Repo
        uses: actions/checkout@v2
      - name: Setup Ubuntu
        run: |
          sudo apt install jq
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.9"
      - name: Install Dependencies in Pipfile
        working-directory: ./mdconverter
        run: |
          pip install --no-cache-dir pipenv
          pipenv install --system --deploy
          pip uninstall -y pipenv virtualenv-clone virtualenv
      - name: Create WebSite Structure
        run: |
          if [ -e website/docs ]; then
          rm -rf website/docs
          fi
          mkdir website/docs
          jq ".target.docs | .[]" ${{ github.event.inputs.website_config_file }} \
           | xargs -I {} cp -r {} website/docs
      - name: Convert Notebook into Markdown
        env:
          TARGET: ./website/docs
          OUTPUT_DIR: ./website/docs
          FIG_DIR_NAME: fig
        run: |
          python mdconverter/convert.py \
            ${{ env.TARGET }} \
            ${{ env.OUTPUT_DIR }} \
            ${{ env.FIG_DIR_NAME }}
      - name: Remove Unnecessary files (but markdown, gif, jpg, png)
        working-directory: ./website/docs
        run: |
          find . -type f \
          | grep -i -v -E '.*\.(md|jpg|jpeg|png|gif)' \
          | xargs -I {} sh -c "echo {} && rm -f {}"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          commit-message: ":notebook_with_decorative_cover: Build docsaurus document, ${{github.run_id}}"
          committer: GitHub <noreply@github.com>
          author: gh-actions <actions@github.com>
          branch: docs/build-docsaurus
          labels: |
            docsaurus
            automerge
          branch-suffix: short-commit-hash
          delete-branch: true
          title: "[${{github.run_id}}] Changes by create-pull-request action"
          body: |
            Automated changes by [create-pull-request](https://github.com/peter-evans/create-pull-request) GitHub action
            ```
            Build new document
            ```
